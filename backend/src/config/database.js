// src/config/database.js
const knex = require('knex');
const knexConfig = require('../../knexfile');

const environment = process.env.NODE_ENV || 'development';
const config = knexConfig[environment];

// Knexã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã®ä½œæˆ
const db = knex(config);

/**
 * ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹æ¥ç¶šã‚’ãƒ†ã‚¹ãƒˆã™ã‚‹é–¢æ•°
 */
async function testConnection() {
  try {
    await db.raw('SELECT 1');
    console.log('âœ… ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹æ¥ç¶šæˆåŠŸ');
    return true;
  } catch (error) {
    console.error('âŒ ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹æ¥ç¶šã‚¨ãƒ©ãƒ¼:', error.message);
    return false;
  }
}

/**
 * ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹æ¥ç¶šã‚’é–‰ã˜ã‚‹é–¢æ•°
 */
async function closeConnection() {
  await db.destroy();
  console.log('ğŸ”Œ ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹æ¥ç¶šã‚’é–‰ã˜ã¾ã—ãŸ');
}

/**
 * ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã‚’å®Ÿè¡Œã™ã‚‹é–¢æ•°
 */
async function runMigrations() {
  try {
    await db.migrate.latest();
    console.log('ğŸ“Š ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³å®Œäº†');
    return true;
  } catch (error) {
    console.error('âŒ ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã‚¨ãƒ©ãƒ¼:', error.message);
    return false;
  }
}

/**
 * ã‚·ãƒ¼ãƒ‰ãƒ‡ãƒ¼ã‚¿ã‚’æŠ•å…¥ã™ã‚‹é–¢æ•°
 */
async function runSeeds() {
  try {
    await db.seed.run();
    console.log('ğŸŒ± ã‚·ãƒ¼ãƒ‰ãƒ‡ãƒ¼ã‚¿æŠ•å…¥å®Œäº†');
    return true;
  } catch (error) {
    console.error('âŒ ã‚·ãƒ¼ãƒ‰ãƒ‡ãƒ¼ã‚¿ã‚¨ãƒ©ãƒ¼:', error.message);
    return false;
  }
}

module.exports = {
  db,
  testConnection,
  closeConnection,
  runMigrations,
  runSeeds
};

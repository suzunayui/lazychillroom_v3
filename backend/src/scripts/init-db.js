// src/scripts/init-db.js
require('dotenv').config();
const { testConnection, runMigrations, runSeeds, closeConnection } = require('../config/database');

async function initializeDatabase() {
  console.log('ğŸš€ ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹åˆæœŸåŒ–ã‚’é–‹å§‹...');
  console.log('');

  try {
    // 1. ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹æ¥ç¶šãƒ†ã‚¹ãƒˆ
    console.log('1ï¸âƒ£ ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹æ¥ç¶šã‚’ãƒ†ã‚¹ãƒˆä¸­...');
    const connected = await testConnection();
    if (!connected) {
      throw new Error('ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã«æ¥ç¶šã§ãã¾ã›ã‚“');
    }
    console.log('');

    // 2. ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³å®Ÿè¡Œ
    console.log('2ï¸âƒ£ ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã‚’å®Ÿè¡Œä¸­...');
    const migrationSuccess = await runMigrations();
    if (!migrationSuccess) {
      throw new Error('ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã«å¤±æ•—ã—ã¾ã—ãŸ');
    }
    console.log('');

    // 3. ã‚·ãƒ¼ãƒ‰ãƒ‡ãƒ¼ã‚¿æŠ•å…¥
    console.log('3ï¸âƒ£ ã‚·ãƒ¼ãƒ‰ãƒ‡ãƒ¼ã‚¿ã‚’æŠ•å…¥ä¸­...');
    const seedSuccess = await runSeeds();
    if (!seedSuccess) {
      throw new Error('ã‚·ãƒ¼ãƒ‰ãƒ‡ãƒ¼ã‚¿ã®æŠ•å…¥ã«å¤±æ•—ã—ã¾ã—ãŸ');
    }
    console.log('');

    console.log('âœ… ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹åˆæœŸåŒ–ãŒå®Œäº†ã—ã¾ã—ãŸï¼');
    console.log('');
    console.log('ğŸ¯ æ¬¡ã®ã‚¹ãƒ†ãƒƒãƒ—:');
    console.log('  1. npm run dev ã§ã‚µãƒ¼ãƒãƒ¼ã‚’èµ·å‹•');
    console.log('  2. http://localhost:5000/health ã§å‹•ä½œç¢ºèª');
    console.log('  3. ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ã®è¨­å®š');

  } catch (error) {
    console.error('âŒ ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹åˆæœŸåŒ–ã‚¨ãƒ©ãƒ¼:', error.message);
    process.exit(1);
  } finally {
    await closeConnection();
  }
}

// ã‚¹ã‚¯ãƒªãƒ—ãƒˆãŒç›´æ¥å®Ÿè¡Œã•ã‚ŒãŸå ´åˆ
if (require.main === module) {
  initializeDatabase();
}

module.exports = { initializeDatabase };
